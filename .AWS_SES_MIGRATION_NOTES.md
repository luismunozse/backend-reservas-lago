# Migración futura a Amazon SES (borrador)

Este archivo resume las decisiones y tareas pendientes para migrar el envío de correos desde MailHog/SMTP local a Amazon SES.

## 1. Identidad y DNS

- Verificar dominio (o remitente) en SES.
- Configurar DNS del dominio:
  - SPF: incluir `amazonses.com`.
  - DKIM: agregar los 3 registros CNAME que proporciona SES.
- Configurar un dominio `MAIL FROM` dedicado (por ejemplo `mail.lago-escondido.com`) para mejorar reputación.

## 2. Salir del sandbox

- Solicitar a AWS que la cuenta SES pase de *sandbox* a *producción*:
  - Justificar caso de uso.
  - Definir volúmenes esperados y tipo de tráfico.
  - Asegurarse de tener política de manejo de rebotes/quejas.

## 3. Integración con Spring Boot

Hay dos opciones principales:

### 3.1 Vía SMTP (más simple)

- Usar `JavaMailSender` como ahora, cambiando solo configuración:
  - `spring.mail.host = email-smtp.<region>.amazonaws.com`
  - `spring.mail.port = 587` (o 465/25 según política)
  - `spring.mail.username = <SMTP_USER>`
  - `spring.mail.password = <SMTP_PASSWORD>`
  - `spring.mail.properties.mail.smtp.auth = true`
  - `spring.mail.properties.mail.smtp.starttls.enable = true`
- Crear un usuario IAM específico para SMTP SES (permisos mínimos).
- Guardar credenciales en variables de entorno, nunca en código.

### 3.2 Vía AWS SDK (más avanzado)

- Crear un servicio específico (por ejemplo `SesEmailSender`) que use el cliente Java de SES v2.
- Ventajas:
  - Posibilidad de usar *Configuration Sets* y tags por mensaje.
  - Enviar usando plantillas de SES si se quieren mantener en AWS.
  - Mejor control de timeouts, reintentos, etc.
- Desventajas:
  - Más código y configuración de AWS en el proyecto.

## 4. Plantillas de email

- Opciones:
  - **Mantener Thymeleaf** como hasta ahora, generando HTML y enviándolo a SES (recomendado al inicio).
  - Migrar a plantillas administradas en SES más adelante si marketing necesita editarlas sin tocar código.
- Asegurarse de que el HTML sea “email-friendly”:
  - Ancho máximo ~600px.
  - Estilos inline donde sea posible.
  - Evitar JS y CSS avanzados que clientes de correo no soportan.

## 5. Monitorización y reputación

- Configurar *Configuration Sets* en SES para:
  - Entregas, rebotes, quejas, aperturas, clics.
  - Enviar eventos a CloudWatch, SNS o EventBridge.
- Implementar manejo de:
  - **Bounces**: dejar de enviar a direcciones que rebotan repetidamente.
  - **Complaints**: excluir destinatarios que marcan como spam.

## 6. Seguridad y entornos

- Usar un usuario IAM dedicado para SES (SMTP o SDK) con permisos mínimos.
- Separar configuración por entorno (`dev`, `stage`, `prod`) usando variables de entorno:
  - Host, credenciales SES, límites de envío, etc.
- En desarrollo:
  - Seguir usando MailHog o un profile separado (`spring.profiles.active=dev`) apuntando a SMTP local.
  - Usar SES solo en `stage`/`prod` cambiando el profile y las variables de entorno.

## 7. Tareas pendientes (TODO)

- [ ] Crear usuario IAM SMTP SES y almacenar credenciales en el gestor de secretos / variables de entorno.
- [ ] Agregar profile `prod` en `application-prod.yml` con configuración SMTP SES.
- [ ] Probar envío de confirmación/cancelación hacia una casilla de test externa (Gmail/Outlook).
- [ ] Configurar `Configuration Set` básico para registrar rebotes y quejas.
- [ ] Documentar procedimiento de rotación de credenciales SES (clave SMTP / access key). 

